- name: Create user {{ item["name"] }}
  ansible.builtin.user:
    name: '{{ item["name"] }}'
    append: true
    groups: '{{ item["groups"] }}'
    password: "*"
    create_home: true
    state: '{{ item["state"] }}'
  become: true
  register: user

- name: Delete password for {{ item["name"] }}
  ansible.builtin.command: passwd --delete {{ item["name"] }}
  become: true
  #when: user.changed

- name: Expire password for {{ item["name"] }}
  ansible.builtin.command: passwd --expire {{ item["name"] }}
  become: true
  #when: user.changed

- name: Create authorized_keys file for {{ item["name"] }}
  block:
    - name: Add .ssh folder
      ansible.builtin.file:
        path: /home/{{ item["name"] }}/.ssh
        state: directory
        mode: '0755'
        owner: '{{ item["name"] }}'
        group: '{{ item["name"] }}'
      become: true

    - name: Add authorized_keys file
      ansible.builtin.template:
        src: ../files/authorized_keys
        dest: /home/{{ item["name"] }}/.ssh/authorized_keys
        mode: '0644'
        owner: '{{ item["name"] }}'
        group: '{{ item["name"] }}'
      become: true
  when:
    - item["state"] == "present"
    - item["ssh_keys"] is defined
    - item["ssh_keys"] is iterable
    - item["ssh_keys"] | length > 0